<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AUM Student Assistant</title>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #0e0e10;
            font-family: "Segoe UI", Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #e4e4e7;
        }

        #chat-container {
            width: 430px;
            height: 80vh;
            background: #18181b;
            border-radius: 18px;
            box-shadow: 0 0 25px rgba(0,0,0,0.35);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #header {
            background: #1f1f23;
            padding: 14px 16px;
            border-bottom: 1px solid #2b2b2f;

            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;

            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }

        #header img {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid #3f3f46;
        }

        #chat {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #18181b;
        }

        .msg {
            max-width: 75%;
            padding: 12px 16px;
            margin-bottom: 14px;
            border-radius: 14px;
            font-size: 15px;
            line-height: 1.45;
            animation: fadeIn 0.2s ease-out;
            white-space: normal;
            word-wrap: break-word;
        }

        .user {
            background: #3b82f6;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .bot {
            background: #27272a;
            color: #e4e4e7;
            border: 1px solid #3f3f46;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        /* Make lists inside bot bubbles look good */
        .bot ul, .bot ol {
            margin: 8px 0 0 18px;
            padding: 0;
        }

        .bot li {
            margin: 4px 0;
        }

        .bot p {
            margin: 0 0 8px 0;
        }

        .bot p:last-child {
            margin-bottom: 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #input-area {
            display: flex;
            padding: 12px;
            border-top: 1px solid #2d2d31;
            background: #1c1c1f;
        }

        #box {
            flex: 1;
            padding: 12px 14px;
            font-size: 16px;
            background: #27272a;
            color: #e4e4e7;
            border: 1px solid #3f3f46;
            border-radius: 10px;
            outline: none;
        }

        #box::placeholder {
            color: #8a8a8f;
        }

        #send {
            margin-left: 10px;
            padding: 12px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        #send:hover {
            background: #2563eb;
        }

        /* links */
        .msg a {
            color:#4da3ff;
            text-decoration: underline;
        }
    </style>
</head>

<body>

<div id="chat-container">
    <div id="header">
        <img src="NaviLearn.jpeg" alt="AUM Logo">
        <span>NaviLearn Student Assistant</span>
    </div>

    <div id="chat"></div>

    <div id="input-area">
        <input id="box" placeholder="Ask something..." onkeydown="if(event.key==='Enter') send()">
        <button id="send" onclick="send()">Send</button>
    </div>
</div>

<script>
/* -------------------------
   Safe text -> HTML helpers
--------------------------*/

// Escape HTML so bot output can't inject tags/scripts.
function escapeHtml(str) {
  return (str || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}

// Convert URLs to <a> tags AFTER escaping.
function linkify(escapedText) {
  return escapedText.replace(
    /(https?:\/\/[^\s]+)/g,
    '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
  );
}

/*
  Render plain text into paragraphs + lists.
  Supports:
    - bullet lines starting with "- " or "* "
    - numbered lines starting with "1. " "2. " etc.
  Everything is safely escaped.
*/
function renderRichText(rawText) {
  const text = (rawText || "").replace(/\r\n/g, "\n");
  const lines = text.split("\n");

  let html = "";
  let inUl = false;
  let inOl = false;
  let paragraph = [];

  function flushParagraph() {
    if (paragraph.length) {
      const joined = paragraph.join(" ").trim();
      if (joined) {
        const escaped = linkify(escapeHtml(joined));
        html += `<p>${escaped}</p>`;
      }
      paragraph = [];
    }
  }

  function closeLists() {
    if (inUl) { html += "</ul>"; inUl = false; }
    if (inOl) { html += "</ol>"; inOl = false; }
  }

  for (const rawLine of lines) {
    const line = rawLine.trim();

    // Blank line => paragraph break + close lists
    if (!line) {
      flushParagraph();
      closeLists();
      continue;
    }

    // Bullet line
    if (line.startsWith("- ") || line.startsWith("* ")) {
      flushParagraph();
      if (inOl) { html += "</ol>"; inOl = false; }
      if (!inUl) { html += "<ul>"; inUl = true; }
      const item = linkify(escapeHtml(line.slice(2).trim()));
      html += `<li>${item}</li>`;
      continue;
    }

    // Numbered line: "1. something"
    const m = line.match(/^(\d+)\.\s+(.*)$/);
    if (m) {
      flushParagraph();
      if (inUl) { html += "</ul>"; inUl = false; }
      if (!inOl) { html += "<ol>"; inOl = true; }
      const item = linkify(escapeHtml(m[2].trim()));
      html += `<li>${item}</li>`;
      continue;
    }

    // Normal line => part of paragraph
    closeLists();
    paragraph.push(line);
  }

  flushParagraph();
  closeLists();

  return html || `<p>${linkify(escapeHtml(rawText || ""))}</p>`;
}

/* -------------------------
   Chat UI
--------------------------*/

function addMessage(text, sender) {
  const msg = document.createElement("div");
  msg.className = "msg " + sender;

  if (sender === "bot") {
    msg.innerHTML = renderRichText(text);
  } else {
    // user message: escape + linkify, but keep as one paragraph
    msg.innerHTML = `<p>${linkify(escapeHtml(text))}</p>`;
  }

  document.getElementById("chat").appendChild(msg);
  msg.scrollIntoView();
}

async function send() {
  const input = document.getElementById("box");
  const question = input.value.trim();
  if (!question) return;

  addMessage(question, "user");
  input.value = "";

  const thinking = document.createElement("div");
  thinking.className = "msg bot";
  thinking.innerHTML = "<p>Thinkingâ€¦</p>";
  document.getElementById("chat").appendChild(thinking);
  document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;

  try {
    const res = await fetch("PASTE THE LINK HERE, DON'T FORGET /ask", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question })
    });

    const data = await res.json();
    thinking.remove();
    addMessage(data.answer || "No answer returned.", "bot");
  } catch (error) {
    thinking.remove();
    addMessage("Connection error.", "bot");
  }
}
</script>

</body>
</html>
